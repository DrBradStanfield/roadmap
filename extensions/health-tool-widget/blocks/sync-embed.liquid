{% if customer %}
<script>
(function() {
  var STORAGE_KEY = 'health_roadmap_data';
  var SYNC_FLAG = 'health_roadmap_sync_done';
  var PROXY = '/apps/health-tool-1/api/measurements';

  // Field name → metric_type mapping (health metrics only)
  var FIELD_MAP = {
    heightCm: 'height', weightKg: 'weight', waistCm: 'waist',
    hba1c: 'hba1c', ldlC: 'ldl', totalCholesterol: 'total_cholesterol', hdlC: 'hdl',
    triglycerides: 'triglycerides', apoB: 'apob',
    systolicBp: 'systolic_bp', diastolicBp: 'diastolic_bp'
  };

  try {
    // Skip if the health widget is on this page — it handles its own sync
    if (document.getElementById('health-tool-root')) return;
    if (sessionStorage.getItem(SYNC_FLAG)) return;
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    var stored = JSON.parse(raw);
    var inputs = stored && stored.inputs;
    if (!inputs || Object.keys(inputs).length === 0) return;

    // Check if cloud already has data
    fetch(PROXY).then(function(r) { return r.json(); }).then(function(result) {
      if (result.success && ((result.data && result.data.length > 0) || result.profile)) {
        // Cloud has data — clear localStorage and mark done
        localStorage.removeItem(STORAGE_KEY);
        sessionStorage.setItem(SYNC_FLAG, '1');
        return;
      }

      // Build measurement entries (health metrics only)
      var entries = [];
      for (var field in FIELD_MAP) {
        var val = inputs[field];
        if (val === undefined || val === null || val === '') continue;
        var metricType = FIELD_MAP[field];
        var numVal = Number(val);
        if (isNaN(numVal)) continue;
        entries.push({ metricType: metricType, value: numVal });
      }

      // Build medication entries from cached medications array
      var medications = (stored && stored.medications) || [];

      // Build profile object (demographics)
      var profile = {};
      if (inputs.sex !== undefined && inputs.sex !== null && inputs.sex !== '') {
        profile.sex = inputs.sex === 'male' ? 1 : 2;
      }
      if (inputs.birthYear !== undefined && inputs.birthYear !== null && inputs.birthYear !== '') {
        profile.birthYear = Number(inputs.birthYear);
      }
      if (inputs.birthMonth !== undefined && inputs.birthMonth !== null && inputs.birthMonth !== '') {
        profile.birthMonth = Number(inputs.birthMonth);
      }
      if (inputs.unitSystem !== undefined && inputs.unitSystem !== null && inputs.unitSystem !== '') {
        profile.unitSystem = inputs.unitSystem === 'si' ? 1 : 2;
      }

      var hasProfile = Object.keys(profile).length > 0;
      if (entries.length === 0 && !hasProfile && medications.length === 0 && screenings.length === 0) return;

      // POST profile first (if present), then measurements sequentially.
      // Sequential pattern avoids race conditions in getOrCreateSupabaseUser().
      // Build screening entries from cached screenings array
      var screenings = (stored && stored.screenings) || [];

      function postScreenings(i) {
        if (i >= screenings.length) {
          localStorage.removeItem(STORAGE_KEY);
          sessionStorage.setItem(SYNC_FLAG, '1');
          return;
        }
        var scr = screenings[i];
        if (!scr.screeningKey || !scr.value) { postScreenings(i + 1); return; }
        fetch(PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ screening: { screeningKey: scr.screeningKey, value: scr.value } })
        }).then(function() { postScreenings(i + 1); });
      }

      function postMedications(i) {
        if (i >= medications.length) {
          postScreenings(0);
          return;
        }
        var med = medications[i];
        if (!med.medicationKey || !med.value) { postMedications(i + 1); return; }
        fetch(PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ medication: { medicationKey: med.medicationKey, value: med.value } })
        }).then(function() { postMedications(i + 1); });
      }

      function postMeasurements(i) {
        if (i >= entries.length) {
          postMedications(0);
          return;
        }
        fetch(PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(entries[i])
        }).then(function() { postMeasurements(i + 1); });
      }

      if (hasProfile) {
        fetch(PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ profile: profile })
        }).then(function() { postMeasurements(0); });
      } else {
        postMeasurements(0);
      }
    });
  } catch (e) {
    // Silent fail — don't break the page
  }
})();
</script>
{% endif %}

{% schema %}
{
  "name": "Health Data Sync",
  "target": "body",
  "settings": []
}
{% endschema %}

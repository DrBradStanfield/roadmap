{% if customer %}
<script>
(function() {
  var STORAGE_KEY = 'health_roadmap_data';
  var SYNC_FLAG = 'health_roadmap_sync_done';
  var PROXY = '/apps/health-tool-1/api/measurements';

  // Field name → metric_type mapping (health metrics only, no height — height goes to profile)
  var FIELD_MAP = {
    weightKg: 'weight', waistCm: 'waist',
    hba1c: 'hba1c', ldlC: 'ldl', totalCholesterol: 'total_cholesterol', hdlC: 'hdl',
    triglycerides: 'triglycerides', apoB: 'apob',
    systolicBp: 'systolic_bp', diastolicBp: 'diastolic_bp'
  };

  try {
    // Skip if the health widget is on this page — it handles its own sync
    if (document.getElementById('health-tool-root')) return;
    if (sessionStorage.getItem(SYNC_FLAG)) return;
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    var stored = JSON.parse(raw);
    var inputs = stored && stored.inputs;
    if (!inputs || Object.keys(inputs).length === 0) return;

    // Check if cloud already has meaningful health data
    function hasProfileData(p) {
      return p && (p.sex != null || p.birthYear != null || p.height != null || p.unitSystem != null);
    }
    fetch(PROXY).then(function(r) { return r.json(); }).then(function(result) {
      if (result.success && (
        (result.data && result.data.length > 0) ||
        hasProfileData(result.profile) ||
        (result.medications && result.medications.length > 0) ||
        (result.screenings && result.screenings.length > 0)
      )) {
        // Cloud has meaningful data — clear localStorage and mark done
        localStorage.removeItem(STORAGE_KEY);
        sessionStorage.setItem(SYNC_FLAG, '1');
        return;
      }

      // Build measurement entries (health metrics only)
      var entries = [];
      for (var field in FIELD_MAP) {
        var val = inputs[field];
        if (val === undefined || val === null || val === '') continue;
        var metricType = FIELD_MAP[field];
        var numVal = Number(val);
        if (isNaN(numVal)) continue;
        entries.push({ metricType: metricType, value: numVal });
      }

      // Build medication entries from cached medications array
      var medications = (stored && stored.medications) || [];
      var screenings = (stored && stored.screenings) || [];

      // Build profile object (demographics)
      var profile = {};
      if (inputs.sex !== undefined && inputs.sex !== null && inputs.sex !== '') {
        profile.sex = inputs.sex === 'male' ? 1 : 2;
      }
      if (inputs.birthYear !== undefined && inputs.birthYear !== null && inputs.birthYear !== '') {
        profile.birthYear = Number(inputs.birthYear);
      }
      if (inputs.birthMonth !== undefined && inputs.birthMonth !== null && inputs.birthMonth !== '') {
        profile.birthMonth = Number(inputs.birthMonth);
      }
      var unitPref = inputs.unitSystem || localStorage.getItem('health_roadmap_unit_system');
      if (unitPref) {
        profile.unitSystem = unitPref === 'si' ? 1 : 2;
      }
      if (inputs.heightCm !== undefined && inputs.heightCm !== null && inputs.heightCm !== '') {
        profile.height = Number(inputs.heightCm);
      }

      var hasProfile = Object.keys(profile).length > 0;
      if (entries.length === 0 && !hasProfile && medications.length === 0 && screenings.length === 0) return;

      // POST profile first (if present), then measurements sequentially.
      // Sequential pattern avoids race conditions in getOrCreateSupabaseUser().
      function syncComplete() {
        // Trigger welcome email after all data is synced (fire-and-forget)
        fetch(PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sendWelcomeEmail: true })
        }).finally(function() {
          localStorage.removeItem(STORAGE_KEY);
          // Set auth flag so auto-redirect works on direct navigation to widget pages.
          // Safe: only reached after successful sync (localStorage had data), never after data deletion
          // (clearLocalStorage removes STORAGE_KEY, so sync-embed exits early at line 21).
          localStorage.setItem('health_roadmap_authenticated', '1');
          sessionStorage.setItem(SYNC_FLAG, '1');
        });
      }

      function postScreenings(i) {
        if (i >= screenings.length) {
          syncComplete();
          return;
        }
        var scr = screenings[i];
        if (!scr.screeningKey || !scr.value) { postScreenings(i + 1); return; }
        fetch(PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ screening: { screeningKey: scr.screeningKey, value: scr.value } })
        }).then(function(r) { if (!r.ok) console.warn('sync-embed: screening sync failed', r.status); })
          .catch(function() {})
          .then(function() { postScreenings(i + 1); });
      }

      function postMedications(i) {
        if (i >= medications.length) {
          postScreenings(0);
          return;
        }
        var med = medications[i];
        if (!med.medicationKey || !med.drugName) { postMedications(i + 1); return; }
        fetch(PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ medication: {
            medicationKey: med.medicationKey,
            drugName: med.drugName,
            doseValue: med.doseValue || null,
            doseUnit: med.doseUnit || null
          } })
        }).then(function(r) { if (!r.ok) console.warn('sync-embed: medication sync failed', r.status); })
          .catch(function() {})
          .then(function() { postMedications(i + 1); });
      }

      function postMeasurements(i) {
        if (i >= entries.length) {
          postMedications(0);
          return;
        }
        fetch(PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(entries[i])
        }).then(function(r) { if (!r.ok) console.warn('sync-embed: measurement sync failed', r.status); })
          .catch(function() {})
          .then(function() { postMeasurements(i + 1); });
      }

      if (hasProfile) {
        fetch(PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ profile: profile })
        }).then(function(r) { if (!r.ok) console.warn('sync-embed: profile sync failed', r.status); })
          .catch(function() {})
          .then(function() { postMeasurements(0); });
      } else {
        postMeasurements(0);
      }
    });
  } catch (e) {
    // Silent fail — don't break the page
  }
})();
</script>
{% else %}
<script>
(function() {
  try {
    if (localStorage.getItem('health_roadmap_authenticated')) {
      localStorage.removeItem('health_roadmap_data');
      localStorage.removeItem('health_roadmap_authenticated');
    }
  } catch(e) {}
})();
</script>
{% endif %}

{% schema %}
{
  "name": "Health Data Sync",
  "target": "body",
  "settings": []
}
{% endschema %}
